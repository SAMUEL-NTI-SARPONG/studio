/// <reference lib="webworker" />

// This is a custom service worker file that will be merged with the default
// Next-PWA service worker. You can add any custom logic here.

let notificationTimeout;

self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SCHEDULE_NOTIFICATION') {
    const { payload } = event.data;
    const now = Date.now();
    const delay = payload.options.timestamp - now;

    console.log(`[SW] Scheduling notification for ${payload.title} in ${delay / 1000} seconds.`);

    if (delay > 0) {
      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
      }
      notificationTimeout = setTimeout(() => {
        console.log(`[SW] Showing notification for ${payload.title}`);
        self.registration.showNotification(payload.title, {
          ...payload.options,
          body: payload.options.body,
          vibrate: [200, 100, 200],
          sound: '/notification.mp3', // Note: sound is not supported in all browsers
        });
      }, delay);
    }
  } else if (event.data && event.data.type === 'CANCEL_NOTIFICATIONS') {
    console.log('[SW] Cancelling scheduled notifications.');
    if (notificationTimeout) {
      clearTimeout(notificationTimeout);
    }
  }
});

self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
      if (clientList.length > 0) {
        let client = clientList[0];
        for (let i = 0; i < clientList.length; i++) {
          if (clientList[i].focused) {
            client = clientList[i];
          }
        }
        return client.focus();
      }
      return clients.openWindow('/');
    })
  );
});

// Import the default service worker generated by next-pwa
// This is important to ensure that all the PWA features like caching work correctly.
// The path might need adjustment based on your project structure.
try {
  importScripts('/sw.js');
} catch (e) {
  console.error("Could not import workbox script", e);
}
